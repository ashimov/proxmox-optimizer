---
- name: Set RAM size fact
  ansible.builtin.set_fact:
    ram_size_gb: "{{ (ansible_memtotal_mb / 1024) | int }}"

- name: Install KSM tuning daemon
  ansible.builtin.apt:
    name: ksm-control-daemon
    state: present
  when: xs_ksmtuned | lower == "yes"

- name: Set KSM tuning values
  ansible.builtin.set_fact:
    ksm_thres_coef: "{{ 50 if ram_size_gb | int <= 16 else 40 if ram_size_gb | int <= 32 else 30 if ram_size_gb | int <= 64 else 20 if ram_size_gb | int <= 128 else 10 }}"
    ksm_sleep_msec: "{{ 80 if ram_size_gb | int <= 16 else 60 if ram_size_gb | int <= 32 else 40 if ram_size_gb | int <= 64 else 20 if ram_size_gb | int <= 128 else 10 }}"
  when: xs_ksmtuned | lower == "yes"

- name: Configure KSM tuning
  ansible.builtin.lineinfile:
    path: /etc/ksmtuned.conf
    regexp: '^#?KSM_THRES_COEF='
    line: "KSM_THRES_COEF={{ ksm_thres_coef }}"
  when: xs_ksmtuned | lower == "yes"
  notify: Restart ksmtuned

- name: Configure KSM sleep interval
  ansible.builtin.lineinfile:
    path: /etc/ksmtuned.conf
    regexp: '^#?KSM_SLEEP_MSEC='
    line: "KSM_SLEEP_MSEC={{ ksm_sleep_msec }}"
  when: xs_ksmtuned | lower == "yes"
  notify: Restart ksmtuned

- name: Enable ksmtuned service
  ansible.builtin.systemd:
    name: ksmtuned
    enabled: true
    state: started
  when: xs_ksmtuned | lower == "yes"

- name: Detect AMD EPYC or Ryzen
  ansible.builtin.set_fact:
    amd_detected: "{{ ('EPYC' in (ansible_facts['processor'] | join(' '))) or ('Ryzen' in (ansible_facts['processor'] | join(' '))) }}"

- name: Check for GRUB_CMDLINE_LINUX_DEFAULT
  ansible.builtin.command: grep -q '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub
  register: grub_cmdline_check
  changed_when: false
  failed_when: false
  when: xs_amdfixes | lower == "yes" and amd_detected

- name: Ensure GRUB_CMDLINE_LINUX_DEFAULT exists
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    line: 'GRUB_CMDLINE_LINUX_DEFAULT=""'
    insertafter: EOF
    create: yes
  when: xs_amdfixes | lower == "yes" and amd_detected and (grub_cmdline_check.rc | default(0)) != 0

- name: Ensure idle=nomwait in GRUB cmdline
  ansible.builtin.replace:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX_DEFAULT=")(?!.*\bidle=nomwait\b)([^"]*)"'
    replace: '\1\2 idle=nomwait"'
  when: xs_amdfixes | lower == "yes" and amd_detected
  notify:
    - Update grub
    - Refresh EFI boot

- name: Configure KVM ignore_msrs options
  ansible.builtin.blockinfile:
    path: /etc/modprobe.d/kvm.conf
    create: yes
    block: |
      options kvm ignore_msrs=Y
      options kvm report_ignored_msrs=N
  when: xs_amdfixes | lower == "yes" and amd_detected

- name: Get Proxmox version for AMD kernel
  ansible.builtin.command: pveversion
  register: pveversion_out
  changed_when: false
  when: xs_amdfixes | lower == "yes" and amd_detected

- name: Set Proxmox major version for AMD kernel
  ansible.builtin.set_fact:
    proxmox_pve_major: "{{ (pveversion_out.stdout | regex_search('pve-manager/(\\d+)', '\\1') | default(['8'])) | first | int }}"
  when: xs_amdfixes | lower == "yes" and amd_detected

- name: Select AMD kernel package
  ansible.builtin.set_fact:
    amd_kernel_package: "{{ 'pve-kernel-6.11' if proxmox_pve_major | int >= 9 else ('pve-kernel-6.8' if proxmox_pve_major | int >= 8 else 'pve-kernel-5.15') }}"
  when: xs_amdfixes | lower == "yes" and amd_detected

- name: Install AMD kernel package
  ansible.builtin.apt:
    name: "{{ amd_kernel_package }}"
    state: present
  when: xs_amdfixes | lower == "yes" and amd_detected

- name: Determine sysctl applicability
  ansible.builtin.set_fact:
    xs_sysctl_apply: "{{ ansible_virtualization_type | default('') != 'lxc' }}"

- name: Configure kernel panic sysctl
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-kernelpanic.conf
    state: present
    sysctl_set: true
  loop:
    - name: kernel.core_pattern
      value: "/var/crash/core.%t.%p"
    - name: kernel.panic
      value: "10"
    - name: kernel.panic_on_oops
      value: "1"
    - name: kernel.hardlockup_panic
      value: "1"
  when: xs_kernelpanic | lower == "yes" and xs_sysctl_apply

- name: Remove kernel panic sysctl config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-kernelpanic.conf
    state: absent
  when: xs_kernelpanic | lower != "yes"

- name: Configure max inotify watches
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-maxwatches.conf
    state: present
    sysctl_set: true
  loop:
    - name: fs.inotify.max_user_watches
      value: "1048576"
    - name: fs.inotify.max_user_instances
      value: "1048576"
    - name: fs.inotify.max_queued_events
      value: "1048576"
  when: xs_limits | lower == "yes" and xs_sysctl_apply

- name: Remove max inotify watches config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-maxwatches.conf
    state: absent
  when: xs_limits | lower != "yes"

- name: Configure limits
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-xs-limits.conf
    content: |
      # ashimov.com
      * soft     nproc          1048576
      * hard     nproc          1048576
      * soft     nofile         1048576
      * hard     nofile         1048576
      root soft     nproc          unlimited
      root hard     nproc          unlimited
      root soft     nofile         unlimited
      root hard     nofile         unlimited
    owner: root
    group: root
    mode: "0644"
  when: xs_limits | lower == "yes"

- name: Configure max keys
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-maxkeys.conf
    state: present
    sysctl_set: true
  loop:
    - name: kernel.keys.root_maxkeys
      value: "1000000"
    - name: kernel.keys.maxkeys
      value: "1000000"
  when: xs_limits | lower == "yes" and xs_sysctl_apply

- name: Remove max keys config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-maxkeys.conf
    state: absent
  when: xs_limits | lower != "yes"

- name: Configure systemd limits
  ansible.builtin.lineinfile:
    path: /etc/systemd/system.conf
    regexp: '^DefaultLimitNOFILE='
    line: 'DefaultLimitNOFILE=256000'
  when: xs_limits | lower == "yes"
  notify: Reload systemd

- name: Configure systemd user limits
  ansible.builtin.lineinfile:
    path: /etc/systemd/user.conf
    regexp: '^DefaultLimitNOFILE='
    line: 'DefaultLimitNOFILE=256000'
  when: xs_limits | lower == "yes"
  notify: Reload systemd

- name: Ensure pam_limits is enabled
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session
    regexp: '^session required pam_limits.so'
    line: 'session required pam_limits.so'
  when: xs_limits | lower == "yes"

- name: Ensure pam_limits for runuser
  ansible.builtin.lineinfile:
    path: /etc/pam.d/runuser-l
    regexp: '^session required pam_limits.so'
    line: 'session required pam_limits.so'
  when: xs_limits | lower == "yes"

- name: Configure root ulimit
  ansible.builtin.lineinfile:
    path: /root/.profile
    regexp: '^ulimit -n '
    line: 'ulimit -n 256000'
  when: xs_limits | lower == "yes"

- name: Configure logrotate
  ansible.builtin.copy:
    dest: /etc/logrotate.conf
    content: |
      # ashimov.com
      daily
      su root adm
      rotate 7
      create
      compress
      size=10M
      delaycompress
      copytruncate

      include /etc/logrotate.d
    owner: root
    group: root
    mode: "0644"
  when: xs_logrotate | lower == "yes"
  notify: Validate logrotate config

- name: Configure journald
  ansible.builtin.copy:
    dest: /etc/systemd/journald.conf
    content: |
      # ashimov.com
      [Journal]
      Storage=persistent
      SplitMode=none
      RateLimitInterval=0
      RateLimitIntervalSec=0
      RateLimitBurst=0
      ForwardToSyslog=no
      ForwardToWall=yes
      Seal=no
      Compress=yes
      SystemMaxUse=64M
      RuntimeMaxUse=60M
      MaxLevelStore=info
      MaxLevelSyslog=warning
      MaxLevelKMsg=warning
      MaxLevelConsole=notice
      MaxLevelWall=crit
    owner: root
    group: root
    mode: "0644"
  when: xs_journald | lower == "yes"
  notify: Restart journald

- name: Install haveged
  ansible.builtin.apt:
    name: haveged
    state: present
  when: xs_entropy | lower == "yes"

- name: Configure haveged
  ansible.builtin.copy:
    dest: /etc/default/haveged
    content: |
      # ashimov.com
      DAEMON_ARGS="-w 1024"
    owner: root
    group: root
    mode: "0644"
  when: xs_entropy | lower == "yes"
  notify: Restart haveged

- name: Enable haveged
  ansible.builtin.systemd:
    name: haveged
    enabled: true
  when: xs_entropy | lower == "yes"

- name: Configure vzdump
  ansible.builtin.lineinfile:
    path: /etc/vzdump.conf
    regexp: '^#?bwlimit:'
    line: 'bwlimit: 0'
  when: xs_vzdump | lower == "yes"

- name: Configure vzdump ionice
  ansible.builtin.lineinfile:
    path: /etc/vzdump.conf
    regexp: '^#?ionice:'
    line: 'ionice: 5'
  when: xs_vzdump | lower == "yes"

- name: Configure memory sysctl
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-memory.conf
    state: present
    sysctl_set: true
  loop:
    - name: vm.min_free_kbytes
      value: "1048576"
    - name: vm.nr_hugepages
      value: "72"
    - name: vm.max_map_count
      value: "262144"
    - name: vm.overcommit_memory
      value: "1"
  when: xs_memoryfixes | lower == "yes" and xs_sysctl_apply

- name: Remove memory sysctl config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-memory.conf
    state: absent
  when: xs_memoryfixes | lower != "yes"

- name: Configure TCP BBR
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-kernel-bbr.conf
    state: present
    sysctl_set: true
  loop:
    - name: net.core.default_qdisc
      value: "fq"
    - name: net.ipv4.tcp_congestion_control
      value: "bbr"
  when: xs_tcpbbr | lower == "yes" and xs_sysctl_apply

- name: Remove TCP BBR config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-kernel-bbr.conf
    state: absent
  when: xs_tcpbbr | lower != "yes"

- name: Configure TCP fastopen
  ansible.posix.sysctl:
    name: net.ipv4.tcp_fastopen
    value: "3"
    sysctl_file: /etc/sysctl.d/99-xs-tcp-fastopen.conf
    state: present
    sysctl_set: true
  when: xs_tcpfastopen | lower == "yes" and xs_sysctl_apply

- name: Remove TCP fastopen config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-tcp-fastopen.conf
    state: absent
  when: xs_tcpfastopen | lower != "yes"

- name: Check for nf_conntrack_helper sysctl
  ansible.builtin.stat:
    path: /proc/sys/net/netfilter/nf_conntrack_helper
  register: proxmox_nf_conntrack_helper_sysctl
  when: xs_net | lower == "yes" and xs_sysctl_apply

- name: Remove unsupported nf_conntrack_helper sysctl config
  ansible.posix.sysctl:
    name: net.netfilter.nf_conntrack_helper
    sysctl_file: /etc/sysctl.d/99-xs-net.conf
    state: absent
    sysctl_set: false
  when:
    - xs_net | lower == "yes" and xs_sysctl_apply
    - not (proxmox_nf_conntrack_helper_sysctl.stat.exists | default(false))

- name: Configure network sysctl
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-net.conf
    state: present
    sysctl_set: true
  loop:
    - name: net.core.netdev_max_backlog
      value: "8192"
    - name: net.core.optmem_max
      value: "8192"
    - name: net.core.rmem_max
      value: "16777216"
    - name: net.core.somaxconn
      value: "8151"
    - name: net.core.wmem_max
      value: "16777216"
    - name: net.ipv4.conf.all.accept_redirects
      value: "0"
    - name: net.ipv4.conf.all.accept_source_route
      value: "0"
    - name: net.ipv4.conf.all.log_martians
      value: "0"
    - name: net.ipv4.conf.all.rp_filter
      value: "1"
    - name: net.ipv4.conf.all.secure_redirects
      value: "0"
    - name: net.ipv4.conf.all.send_redirects
      value: "0"
    - name: net.ipv4.conf.default.accept_redirects
      value: "0"
    - name: net.ipv4.conf.default.accept_source_route
      value: "0"
    - name: net.ipv4.conf.default.log_martians
      value: "0"
    - name: net.ipv4.conf.default.rp_filter
      value: "1"
    - name: net.ipv4.conf.default.secure_redirects
      value: "0"
    - name: net.ipv4.conf.default.send_redirects
      value: "0"
    - name: net.ipv4.icmp_echo_ignore_broadcasts
      value: "1"
    - name: net.ipv4.icmp_ignore_bogus_error_responses
      value: "1"
    - name: net.ipv4.ip_local_port_range
      value: "1024 65535"
    - name: net.ipv4.tcp_base_mss
      value: "1024"
    - name: net.ipv4.tcp_challenge_ack_limit
      value: "999999999"
    - name: net.ipv4.tcp_fin_timeout
      value: "10"
    - name: net.ipv4.tcp_keepalive_intvl
      value: "30"
    - name: net.ipv4.tcp_keepalive_probes
      value: "3"
    - name: net.ipv4.tcp_keepalive_time
      value: "240"
    - name: net.ipv4.tcp_limit_output_bytes
      value: "65536"
    - name: net.ipv4.tcp_max_syn_backlog
      value: "8192"
    - name: net.ipv4.tcp_max_tw_buckets
      value: "1440000"
    - name: net.ipv4.tcp_mtu_probing
      value: "1"
    - name: net.ipv4.tcp_rfc1337
      value: "1"
    - name: net.ipv4.tcp_rmem
      value: "8192 87380 16777216"
    - name: net.ipv4.tcp_sack
      value: "1"
    - name: net.ipv4.tcp_slow_start_after_idle
      value: "0"
    - name: net.ipv4.tcp_syn_retries
      value: "3"
    - name: net.ipv4.tcp_synack_retries
      value: "2"
    - name: net.ipv4.tcp_tw_reuse
      value: "0"
    - name: net.ipv4.tcp_wmem
      value: "8192 65536 16777216"
    - name: net.netfilter.nf_conntrack_generic_timeout
      value: "60"
    - name: net.netfilter.nf_conntrack_helper
      value: "0"
    - name: net.netfilter.nf_conntrack_max
      value: "524288"
    - name: net.netfilter.nf_conntrack_tcp_timeout_established
      value: "28800"
    - name: net.unix.max_dgram_qlen
      value: "4096"
  when:
    - xs_net | lower == "yes" and xs_sysctl_apply
    - item.name != 'net.netfilter.nf_conntrack_helper' or (proxmox_nf_conntrack_helper_sysctl.stat.exists | default(false))

- name: Remove network sysctl config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-net.conf
    state: absent
  when: xs_net | lower != "yes"

- name: Configure swappiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "10"
    sysctl_file: /etc/sysctl.d/99-xs-swap.conf
    state: present
    sysctl_set: true
  when: xs_swappiness | lower == "yes" and xs_sysctl_apply

- name: Remove swappiness config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-swap.conf
    state: absent
  when: xs_swappiness | lower != "yes"

- name: Configure max fs
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-xs-fs.conf
    state: present
    sysctl_set: true
  loop:
    - name: fs.nr_open
      value: "12000000"
    - name: fs.file-max
      value: "9000000"
    - name: fs.aio-max-nr
      value: "524288"
  when: xs_maxfs | lower == "yes" and xs_sysctl_apply

- name: Remove max fs config when disabled
  ansible.builtin.file:
    path: /etc/sysctl.d/99-xs-fs.conf
    state: absent
  when: xs_maxfs | lower != "yes"

# XS_NOSUBBANNER - Remove subscription banner
- name: Check if proxmoxlib.js exists
  ansible.builtin.stat:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
  register: proxmoxlib_file
  when: xs_nosubbanner | lower == "yes"

- name: Create subscription banner removal script
  ansible.builtin.copy:
    dest: /etc/cron.daily/xs-pve-nosub
    content: |
      #!/bin/sh
      # ashimov.com Remove subscription banner
      sed -i '/data.status/{s/\!//;s/Active/NoMoreNagging/}' /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    owner: root
    group: root
    mode: "0755"
  when: xs_nosubbanner | lower == "yes" and proxmoxlib_file.stat.exists | default(false)

- name: Check if subscription banner already removed
  ansible.builtin.command: grep -q "data.status !== 'Active'" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
  register: banner_check
  changed_when: false
  failed_when: false
  when: xs_nosubbanner | lower == "yes" and proxmoxlib_file.stat.exists | default(false)

- name: Run subscription banner removal
  ansible.builtin.command: /etc/cron.daily/xs-pve-nosub
  when:
    - xs_nosubbanner | lower == "yes" and proxmoxlib_file.stat.exists | default(false)
    - banner_check.rc == 0
  changed_when: true

- name: Create APT hook for subscription nag removal
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/xs-pve-no-nag
    content: >-
      DPkg::Post-Invoke { "dpkg -V proxmox-widget-toolkit | grep -q '/proxmoxlib\.js$';
      if [ \$? -eq 1 ]; then { echo 'Removing subscription nag from UI...';
      sed -i '/data.status/{s/\!//;s/Active/NoMoreNagging/}' /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js;
      }; fi"; };
    owner: root
    group: root
    mode: "0644"
  when: xs_nosubbanner | lower == "yes"

# XS_PIGZ - Parallel gzip compression
- name: Install pigz
  ansible.builtin.apt:
    name: pigz
    state: present
  when: xs_pigz | lower == "yes"

- name: Enable pigz in vzdump
  ansible.builtin.lineinfile:
    path: /etc/vzdump.conf
    regexp: '^#?pigz:'
    line: 'pigz: 1'
  when: xs_pigz | lower == "yes"

- name: Create pigz wrapper script
  ansible.builtin.copy:
    dest: /bin/pigzwrapper
    content: |
      #!/bin/sh
      # ashimov.com
      PATH=/bin:$PATH
      exec /usr/bin/pigz -1 "$@"
    owner: root
    group: root
    mode: "0755"
  when: xs_pigz | lower == "yes"

- name: Check if original gzip exists
  ansible.builtin.stat:
    path: /bin/gzip.original
  register: gzip_original
  when: xs_pigz | lower == "yes"

- name: Backup original gzip
  ansible.builtin.command: mv -f /bin/gzip /bin/gzip.original
  args:
    creates: /bin/gzip.original
  when: xs_pigz | lower == "yes" and not (gzip_original.stat.exists | default(false))
  changed_when: true

- name: Replace gzip with pigz wrapper
  ansible.builtin.copy:
    src: /bin/pigzwrapper
    dest: /bin/gzip
    remote_src: yes
    owner: root
    group: root
    mode: "0755"
  when: xs_pigz | lower == "yes"

# XS_BASHRC - Bash customization
- name: Configure bashrc customization
  ansible.builtin.blockinfile:
    path: /root/.bashrc
    marker: "# {mark} ANSIBLE MANAGED BLOCK - ashimov.com"
    block: |
      export HISTTIMEFORMAT="%d/%m/%y %T "
      alias l='ls -CF'
      alias la='ls -A'
      alias ll='ls -alF'
      alias ls='ls --color=auto'
      source /etc/profile.d/bash_completion.sh 2>/dev/null || true
      export PS1="\[\e[31m\][\[\e[m\]\[\e[38;5;172m\]\u\[\e[m\]@\[\e[38;5;153m\]\h\[\e[m\] \[\e[38;5;214m\]\W\[\e[m\]\[\e[31m\]]\[\e[m\]\\$ "
  when: xs_bashrc | lower == "yes"

- name: Ensure bashrc is sourced in bash_profile
  ansible.builtin.lineinfile:
    path: /root/.bash_profile
    regexp: '^source /root/.bashrc'
    line: 'source /root/.bashrc'
    create: yes
  when: xs_bashrc | lower == "yes"

# XS_MOTD - MOTD banner
- name: Check if MOTD already customized
  ansible.builtin.command: grep -q "ashimov.com" /etc/motd
  register: motd_check
  failed_when: false
  changed_when: false
  when: xs_motd | lower == "yes"

- name: Create custom MOTD banner
  ansible.builtin.shell: |
    cat << 'EOF' > /etc/motd.new
           This system is optimised by: ashimov.com
    EOF
    if [ -f /etc/motd ]; then
      cat /etc/motd >> /etc/motd.new
    fi
    mv /etc/motd.new /etc/motd
  args:
    executable: /bin/bash
  when: xs_motd | lower == "yes" and motd_check.rc != 0
  changed_when: true

# Automatic timezone detection by IP
- name: Get current timezone for comparison
  ansible.builtin.command: timedatectl show --property=Timezone --value
  register: tuning_current_timezone
  changed_when: false
  when: xs_timesync | lower == "yes" and (xs_timezone is not defined or xs_timezone | length == 0)

- name: Get public IP for timezone detection
  ansible.builtin.uri:
    url: https://ipapi.co/timezone
    return_content: yes
    timeout: 10
  register: timezone_result
  failed_when: false
  when: xs_timesync | lower == "yes" and (xs_timezone is not defined or xs_timezone | length == 0)

- name: Set timezone from IP detection
  ansible.builtin.command: timedatectl set-timezone "{{ timezone_result.content }}"
  when:
    - xs_timesync | lower == "yes"
    - xs_timezone is not defined or xs_timezone | length == 0
    - timezone_result.content is defined
    - timezone_result.content | length > 0
    - timezone_result.status == 200
    - timezone_result.content is regex('^[A-Za-z_]+(/[A-Za-z0-9_+-]+)*$')
    - tuning_current_timezone.stdout | default('') != timezone_result.content
  changed_when: true

- name: Set timezone to UTC if detection failed
  ansible.builtin.command: timedatectl set-timezone UTC
  when:
    - xs_timesync | lower == "yes"
    - xs_timezone is not defined or xs_timezone | length == 0
    - timezone_result.status is not defined or timezone_result.status != 200
    - tuning_current_timezone.stdout | default('') != 'UTC'
  changed_when: true

# Journald vacuum and rotate
- name: Vacuum journald logs
  ansible.builtin.command: journalctl --vacuum-size=64M --vacuum-time=1d
  when: xs_journald | lower == "yes"
  changed_when: false
  failed_when: false

- name: Rotate journald logs
  ansible.builtin.command: journalctl --rotate
  when: xs_journald | lower == "yes"
  changed_when: false
  failed_when: false
