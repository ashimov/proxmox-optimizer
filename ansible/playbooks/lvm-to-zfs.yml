---
- name: Dangerous ops - convert LVM to ZFS
  hosts: proxmox
  become: true
  gather_facts: true

  vars:
    dangerous_confirm: "no"
    dangerous_backup_dir: "/root/ansible-backups"
    lvm_mount_point: ""
    lvm_script_path: "/root/ansible-scripts/lvm-2-zfs.sh"

  pre_tasks:
    - name: Check for Proxmox
      ansible.builtin.stat:
        path: /etc/pve/.version
      register: pve_version_file

    - name: Abort if not Proxmox
      ansible.builtin.assert:
        that: pve_version_file.stat.exists
        fail_msg: "This playbook requires Proxmox VE"

    - name: Abort in LXC containers
      ansible.builtin.assert:
        that: ansible_virtualization_type | default('') != 'lxc'
        fail_msg: "This playbook must not run inside an LXC container"

    - name: Validate mount point if provided
      ansible.builtin.stat:
        path: "{{ lvm_mount_point }}"
      register: lvm_mount_stat
      when: lvm_mount_point | length > 0

    - name: Abort if mount point does not exist
      ansible.builtin.assert:
        that: lvm_mount_stat.stat.exists
        fail_msg: "lvm_mount_point does not exist on the target host"
      when: lvm_mount_point | length > 0

    - name: Show requested operation
      ansible.builtin.debug:
        msg: "Requested LVM to ZFS conversion. Mount point={{ lvm_mount_point | default('/var/lib/vz') }}"

    - name: Require confirmation for destructive action
      ansible.builtin.debug:
        msg: "Dry run only. Re-run with -e dangerous_confirm=yes to apply."
      when: dangerous_confirm | lower != "yes"

    - name: End play without changes
      ansible.builtin.meta: end_play
      when: dangerous_confirm | lower != "yes"

  tasks:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ dangerous_backup_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Set backup stamp
      ansible.builtin.set_fact:
        backup_stamp: "{{ ansible_date_time.epoch }}"

    - name: Capture lsblk
      ansible.builtin.command: lsblk -f
      register: lsblk_out
      changed_when: false

    - name: Capture LVM state
      ansible.builtin.command: pvs
      register: pvs_out
      changed_when: false
      failed_when: false

    - name: Capture volume groups
      ansible.builtin.command: vgs
      register: vgs_out
      changed_when: false
      failed_when: false

    - name: Capture logical volumes
      ansible.builtin.command: lvs
      register: lvs_out
      changed_when: false
      failed_when: false

    - name: Capture filesystem usage
      ansible.builtin.command: df -h
      register: df_out
      changed_when: false

    - name: Capture fstab
      ansible.builtin.command: cat /etc/fstab
      register: fstab_out
      changed_when: false

    - name: Write preflight backup report
      ansible.builtin.copy:
        dest: "{{ dangerous_backup_dir }}/lvm-to-zfs-{{ backup_stamp }}.log"
        content: |
          ## LVM to ZFS preflight
          mount_point={{ lvm_mount_point | default('/var/lib/vz') }}

          == lsblk -f ==
          {{ lsblk_out.stdout | default('') }}

          == pvs ==
          rc={{ pvs_out.rc | default('') }}
          {{ pvs_out.stdout | default('') }}
          {{ pvs_out.stderr | default('') }}

          == vgs ==
          rc={{ vgs_out.rc | default('') }}
          {{ vgs_out.stdout | default('') }}
          {{ vgs_out.stderr | default('') }}

          == lvs ==
          rc={{ lvs_out.rc | default('') }}
          {{ lvs_out.stdout | default('') }}
          {{ lvs_out.stderr | default('') }}

          == df -h ==
          {{ df_out.stdout | default('') }}

          == /etc/fstab ==
          {{ fstab_out.stdout | default('') }}
        owner: root
        group: root
        mode: "0600"

    - name: Ensure scripts directory exists
      ansible.builtin.file:
        path: "{{ lvm_script_path | dirname }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy lvm-2-zfs script to target
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../zfs/lvm-2-zfs.sh"
        dest: "{{ lvm_script_path }}"
        owner: root
        group: root
        mode: "0755"

    - name: Run lvm-2-zfs script with custom mount
      ansible.builtin.command:
        argv:
          - "{{ lvm_script_path }}"
          - "{{ lvm_mount_point }}"
      when: lvm_mount_point | length > 0
      changed_when: true

    - name: Run lvm-2-zfs script with default mount
      ansible.builtin.command:
        argv:
          - "{{ lvm_script_path }}"
      when: lvm_mount_point | length == 0
      changed_when: true
