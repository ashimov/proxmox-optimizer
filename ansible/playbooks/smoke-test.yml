---
# Smoke test playbook for idempotency verification
# This playbook runs a minimal subset of tasks to verify Ansible configuration
# Usage: ansible-playbook -i inventory/hosts.ini playbooks/smoke-test.yml --check

- name: Smoke test - Verify Proxmox configuration
  hosts: proxmox
  become: true
  gather_facts: true

  vars:
    # Override dangerous operations for smoke test
    xs_aptupgrade: "no"
    xs_ceph: "no"
    xs_zfsautosnapshot: "no"
    xs_vfio_iommu: "no"
    proxmox_configure_networking: "no"

  tasks:
    - name: Verify Proxmox installation
      ansible.builtin.stat:
        path: /etc/pve/.version
      register: pve_version_file

    - name: Assert Proxmox is installed
      ansible.builtin.assert:
        that:
          - pve_version_file.stat.exists
        fail_msg: "This host does not appear to be a Proxmox VE installation"
        success_msg: "Proxmox VE installation verified"

    - name: Get Proxmox version
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false

    - name: Display Proxmox version
      ansible.builtin.debug:
        msg: "Proxmox version: {{ pve_version.stdout }}"

    - name: Verify OS codename
      ansible.builtin.set_fact:
        proxmox_os_codename: "{{ ansible_lsb.codename | default(ansible_distribution_release) }}"

    - name: Assert valid OS codename
      ansible.builtin.assert:
        that:
          - proxmox_os_codename in ['bullseye', 'bookworm', 'trixie']
        fail_msg: "Unsupported Debian codename: {{ proxmox_os_codename }}"
        success_msg: "Debian {{ proxmox_os_codename }} is supported"

    - name: Check APT sources
      ansible.builtin.stat:
        path: /etc/apt/sources.list
      register: apt_sources

    - name: Assert APT sources exist
      ansible.builtin.assert:
        that:
          - apt_sources.stat.exists
        fail_msg: "APT sources.list not found"
        success_msg: "APT sources.list exists"

    - name: Check network interfaces
      ansible.builtin.stat:
        path: /etc/network/interfaces
      register: network_interfaces

    - name: Assert network interfaces exist
      ansible.builtin.assert:
        that:
          - network_interfaces.stat.exists
        fail_msg: "Network interfaces file not found"
        success_msg: "Network interfaces file exists"

    - name: Check ZFS availability
      ansible.builtin.command: which zfs
      register: zfs_check
      changed_when: false
      failed_when: false

    - name: Display ZFS status
      ansible.builtin.debug:
        msg: "ZFS is {{ 'available' if zfs_check.rc == 0 else 'not available' }}"

    - name: Check CPU vendor
      ansible.builtin.set_fact:
        cpu_vendor: "{{ 'Intel' if 'GenuineIntel' in (ansible_facts['processor'] | join(' ')) else 'AMD' if 'AuthenticAMD' in (ansible_facts['processor'] | join(' ')) else 'Unknown' }}"

    - name: Display CPU vendor
      ansible.builtin.debug:
        msg: "CPU vendor: {{ cpu_vendor }}"

    - name: Check memory
      ansible.builtin.debug:
        msg: "Total memory: {{ ansible_memtotal_mb }} MB ({{ (ansible_memtotal_mb / 1024) | int }} GB)"

    - name: Check virtualization
      ansible.builtin.debug:
        msg: "Virtualization: {{ ansible_virtualization_type | default('none') }} ({{ ansible_virtualization_role | default('host') }})"

    - name: Smoke test summary
      ansible.builtin.debug:
        msg: |
          ========================================
          SMOKE TEST SUMMARY
          ========================================
          Host: {{ inventory_hostname }}
          Proxmox: {{ pve_version.stdout }}
          Debian: {{ proxmox_os_codename }}
          CPU: {{ cpu_vendor }}
          Memory: {{ (ansible_memtotal_mb / 1024) | int }} GB
          ZFS: {{ 'Available' if zfs_check.rc == 0 else 'Not available' }}
          ========================================
          All smoke tests passed!
          ========================================
